<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Builder Journey</title>
    <link rel="stylesheet" href="style-old.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Funnel+Sans:ital@0;1&display=swap" rel="stylesheet">
  </head>
  <body>
    <div class="journey"></div>
    
     <script>
        //settings
        let currentStep = 10;
        let totalSteps = 13;
        let isScrolling = false;
        let startX = 0;
        let scrollLeft = 0;
        let scrollUpdateTimeout = null;

        //creating journey html
        function renderJourney(currentStep,totalSteps) {
          let content = '<div class="journey__inner"><div class="blur"></div>';

          for (let i = 0; i < totalSteps; i++) {
            
            const stepComplete = (i < currentStep - 1);
            const stepCurrent = (i == currentStep - 1);
            const stepLast = (i == totalSteps - 1);

            let stepClasses = 'step';
            stepClasses += stepComplete ? ' complete' : '';
            stepClasses += stepCurrent ? ' current' : '';
            stepClasses += stepLast ? ' last' : '';

            content += '<div class="' + stepClasses + '">';

            if( i < totalSteps - 1) {
              content += '<div class="path"><svg width="100" height="10" viewBox="0 0 100 10" preserveAspectRatio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><line x1="0" y1="5" x2="100" y2="5" /></svg></div>';
            }

            if(stepCurrent && !stepLast) {
              content += '<div class="character__wrap"><div class="character">\
              <img src="./img/journey-character.svg"/>\
            </div>';
            }

            if(stepComplete) {
              
              content += '<div class="badge material-symbols-outlined">check</div><img src="./img/journey-stone-complete.svg" class="stone"/>';
          
            } else if (stepLast) {

              content += '<img src="./img/journey-destination.png" class="destination"/><img src="./img/journey-planet.svg" class="stone"/>';

            } else {

              content += '<div class="badge"></div><img src="./img/journey-stone.svg" class="stone"/>';
          
            }

            if(stepCurrent) {
              content += '</div>';
            }

            content += '</div>';

          }

          content += '</div>';

          document.querySelector('.journey').insertAdjacentHTML('beforeend',content);

          renderControls();
          scrollToCurrent();
          setupSwipeHandlers();

        }

        //inserting controls html
        function renderControls() {

          const controls = '<div class="controls"><div class="controls__buttons"><button class="slide-left material-symbols-outlined">arrow_back</button><button class="slide-right material-symbols-outlined">arrow_forward</button></div><div class="controls__scrollbar"><div class="scrollbar__inner"></div></div>';

          document.querySelector('.journey').insertAdjacentHTML('afterend',controls);
        }

        function setupSwipeHandlers() {
          const container = document.querySelector('.journey');
          
          container.addEventListener('touchstart', handleTouchStart, { passive: false });
          container.addEventListener('touchmove', handleTouchMove, { passive: false });
          container.addEventListener('touchend', handleTouchEnd, { passive: false });
          
          container.addEventListener('mousedown', handleMouseDown);
          container.addEventListener('mousemove', handleMouseMove);
          container.addEventListener('mouseup', handleMouseUp);
          container.addEventListener('mouseleave', handleMouseUp);
          
          container.addEventListener('dragstart', (e) => e.preventDefault());
        }

        function handleTouchStart(e) {
          e.preventDefault();
          const container = document.querySelector('.journey');
          startX = e.touches[0].pageX - container.offsetLeft;
          scrollLeft = container.scrollLeft;
          isScrolling = true;
        }

        function handleTouchMove(e) {
          if (!isScrolling) return;
          e.preventDefault();
          const container = document.querySelector('.journey');
          const x = e.touches[0].pageX - container.offsetLeft;
          const walk = (x - startX) * 2; 
          container.scrollLeft = scrollLeft - walk;
          
          if (scrollUpdateTimeout) clearTimeout(scrollUpdateTimeout);
          scrollUpdateTimeout = setTimeout(() => {
            triggerScroll(container.scrollLeft);
          }, 16); // ~60fps
        }

        function handleTouchEnd(e) {
          isScrolling = false;
          const container = document.querySelector('.journey');
          triggerScroll(container.scrollLeft);
        }

        function handleMouseDown(e) {
          const container = document.querySelector('.journey');
          startX = e.pageX - container.offsetLeft;
          scrollLeft = container.scrollLeft;
          isScrolling = true;
          container.style.cursor = 'grabbing';
        }

        function handleMouseMove(e) {
          if (!isScrolling) return;
          e.preventDefault();
          const container = document.querySelector('.journey');
          const x = e.pageX - container.offsetLeft;
          const walk = (x - startX) * 2;
          container.scrollLeft = scrollLeft - walk;
          
          if (scrollUpdateTimeout) clearTimeout(scrollUpdateTimeout);
          scrollUpdateTimeout = setTimeout(() => {
            triggerScroll(container.scrollLeft);
          }, 16); // ~60fps
        }

        function handleMouseUp(e) {
          isScrolling = false;
          const container = document.querySelector('.journey');
          container.style.cursor = 'grab';
          
          triggerScroll(container.scrollLeft);
        }

        //create scrollbar/click
        function triggerScroll(scrollLeft) {
          try {
            const container = document.querySelector('.journey');
            const buttonRight = document.querySelector('.slide-right');
            const buttonLeft = document.querySelector('.slide-left');

            const scrollOffset = scrollLeft / container.scrollWidth * 100;
            const scrollWidth = container.offsetWidth / container.scrollWidth;
            const scrollbar = document.querySelector('.scrollbar__inner');

            const scrollAmount = Math.min(container.offsetWidth * 0.8, 300);

            buttonRight.onclick = function () {
              const newScrollLeft = container.scrollLeft + scrollAmount;
              container.scrollTo({
                left: newScrollLeft,
                behavior: 'smooth'
              });
              triggerScroll(newScrollLeft);
            };

            buttonLeft.onclick = function () {
              const newScrollLeft = container.scrollLeft - scrollAmount;
              container.scrollTo({
                left: newScrollLeft,
                behavior: 'smooth'
              });
              triggerScroll(newScrollLeft);
            };

            scrollbar.style.left = scrollOffset + '%';
            scrollbar.style.width = scrollWidth * 200 + 'px';

            if(container.scrollWidth > container.offsetWidth) {
                document.querySelector('.controls').style.display = 'block';
                container.style.justifyContent = 'start';

            } else {
              container.style.justifyContent = 'center';
            }
          } catch (error) {
            console.error('Error in triggerScroll:', error);
          }
        }
 
        //ensure current step starts in view
        function scrollToCurrent() {
          try {
            const container = document.querySelector('.journey');
            const currentElement = document.querySelector('.current');
            
            if (!currentElement) {
              triggerScroll(0);
              return;
            }
            
            const currentPlacementX = currentElement.getBoundingClientRect().left;
            const containerRect = container.getBoundingClientRect();

            if( currentPlacementX > containerRect.width) {
                container.scrollTo({
                  left: currentPlacementX - containerRect.width / 2,
                  behavior: 'smooth'
                });
                triggerScroll(currentPlacementX - containerRect.width / 2);
            } else {
              triggerScroll(0);
            }
          } catch (error) {
            console.error('Error in scrollToCurrent:', error);
          }
        }

        //edit button controls
        function changeJourney() {
          try {
            currentStep = parseInt(document.querySelector('input[name=currentStep]').value) || 1;
            totalSteps = parseInt(document.querySelector('input[name=totalSteps]').value) || 6;

            //remove current
            document.querySelector('.journey').innerHTML = '';
            document.querySelector('.controls').remove();

            //recreate
            renderJourney(currentStep,totalSteps);
          } catch (error) {
            console.error('Error in changeJourney:', error);
          }
        }
        
        // Initialize with error handling
        try {
          renderJourney(currentStep, totalSteps);
        } catch (error) {
          console.error('Error initializing journey:', error);
        }

        // Performance monitoring
        function logPerformance() {
          const container = document.querySelector('.journey');
          const steps = document.querySelectorAll('.step');
          console.log('Performance Info:', {
            totalSteps: steps.length,
            containerWidth: container?.offsetWidth,
            scrollWidth: container?.scrollWidth,
            memoryUsage: performance.memory ? {
              used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + 'MB',
              total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024) + 'MB'
            } : 'Not available'
          });
        }

        //setTimeout(logPerformance, 2000);

      </script>

      <div class="edits">
        <div>
          <label>Current Step</label>
          <input type="tel" value="2" name="currentStep"/>
        </div>

        <div>
          <label>Total Steps</label>
          <input type="tel" value="6" name="totalSteps"/>
        </div>
        <div>
          <button onclick="changeJourney()">Reset</button>
        </div>
      </div>
  </body>
</html>
